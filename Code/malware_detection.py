import csv;

'''
Remaining part:
    Malicious files
    last 3 features
    files of Tripti and  Mohit
'''

'''
Ambarish's Captured data: tcp0.csv
Tripti's Captured data: tcp1.csv
Divya's Captured data: tcp2.csv
Mohit's Captured data: tcp3.csv
Malicious file1: tcp4.csv
Malicious file2: tcp5.csv
'''

'''
Row0: Address A
Row1: Port A
Row2: Address B
Row3: Port B
Row4: Packets
Row5: Bytes
Row6: Packets A->B
Row7: Bytes A->B
Row8: Packets B->A
Row9: Bytes B->A
Row10: Rel Start
Row11: Duration
Row12: Bits/s A->B
Row13: Bits/s B->A
'''

###Array of all files###
csv_fr=[]
#csv_fw=csv.writer(open('Results.csv','w')
for i in range(9):
    csv_fr.append(csv.reader(open('tcp'+str(i)+'.csv')));
row1=[['Features','TCP1','TCP2','TCP3','TCP4','MAL1','MAL2','AVG_TCP','AVG_MAL','AVG_TCP_3'],
      ['Avg Packet Size','0','0','0','0','0','0','0','0','0'],
      ['Avg Flow Duration','0','0','0','0','0','0','0','0','0'],
      ['Avg No. of Packets Sent Per Flow','0','0','0','0','0','0','0','0','0'],
      ['Avg No. of Packets Recvd Pr Flw','0','0','0','0','0','0','0','0','0'],
      ['Avg amt byts sent pr flw','0','0','0','0','0','0','0','0','0'],
      ['Avg byte recvd per flow','0','0','0','0','0','0','0','0','0'],
      ['Avg ratio of incoming to outgoing','0','0','0','0','0','0','0','0','0'],
      ['outgoing to incoming ','0','0','0','0','0','0','0','0','0'],
      ['time floaterval between packet sent','0','0','0','0','0','0','0','0','0'],
      ['time floatrvl bw packets rcvd','0','0','0','0','0','0','0','0','0'],
      ['connection per IP','0','0','0','0','0','0','0','0','0'],
      ['Average Packets Sent per Second','0','0','0','0','0','0','0','0','0'],
      ['Average Packets Received per Second','0','0','0','0','0','0','0','0','0'],
      ['Average Bytes Sent per Second','0','0','0','0','0','0','0','0','0'],
      ['Average Bytes Received per Second','0','0','0','0','0','0','0','0','0']
      ] 
#row1=[['Features','TCP1','TCP2','TCP3','TCP4','Malicious 1', 'Malicious 2'],['f1'],['f2'],['f3'],['f4'],['f5'],['f6'],['f7'],['f8'],['f9'],['f10'],['f11']]

'''
count_row: total no. of rows in a csv file

### Feature 1: Average Packet Size ###
avg_pkt_per_flow: 
avg_pkt_size:

### Feature 2: Average Flow Duration###
total_duration:
avg_flow_duration:

### Feature 3: Average no of Packets Sent per Flow###
total_pkt_a_b:
avg_pkt_a_b:

### Feature 4: Average no of Packets Received per Flow###
total_pkt_b_a:
avg_pkt_b_a:

### Feature 5: Average amount of Bytes Sent per Flow###
total_bytes_a_b:
avg_bytes_a_b:

### Feature 6: Average amount of Bytes Received per Flow###
total_bytes_b_a:
avg_bytes_b_a:

### Feature 7: Average Ratio of Incoming to Outgoing Packets###
total_ratio_a_b_b_a:
avg_ratio_a_b_b_a:

### Feature 8: Average Ratio of Outgoing to Incoming Bytes###
total_ratio_b_a_a_b:
avg_ratio_b_a_a_b:

### Feature 9: Average Time Interval b/w Packets Sent###
time_floaterval_a_b
avg_time_floaterval_a_b

### Feature 10:Average Time Interval b/w Packets Received###
time_floaterval_b_a
avg_time_floaterval_b_a

### Feature 11: Average Ratio of Connections to Number of Destination IPs###

### Feature 12: Average Packet sent per second###
pkt_sent_per_sec
avg_pkt_sent_per_sec

### Feature 13: Average Packet received per second###
pkt_recv_per_sec
avg_recv_sent_per_sec

### Feature 14: Average Bytes sent per second###
bytes_sent_per_sec
avg_bytes_sent_per_sec

### Feature 15: Average Bytes recieved per second###
bytes_recv_per_sec
avg_bytes_recv_per_sec

'''
for i in range(9):
    '''Initialosation of variables'''
    count_row = 0;
    avg_pkt_per_flow = 0
    total_duration = 0;	
    total_pkt_a_b = 0;
    total_pkt_b_a = 0;
    total_bytes_a_b = 0;
    total_bytes_b_a = 0;
    total_ratio_a_b_b_a = 0;
    total_ratio_b_a_a_b = 0;
    time_floaterval_a_b = 0;
    avg_time_floaterval_a_b = 0;
    time_floaterval_b_a = 0;
    avg_time_floaterval_b_a = 0;
    pkt_sent_per_sec = 0;
    pkt_recv_per_sec = 0;
    bytes_sent_per_sec = 0;
    bytes_recv_per_sec = 0;

    connections=set()
    ips=set()
    next(csv_fr[i], None)

    '''Extract each features and use it for calculation'''	
    for row in csv_fr[i]:
        count_row = count_row + 1;
        if(float(row[4])!= 0):
            avg_pkt_per_flow = avg_pkt_per_flow + (float(row[5])/float(row[4]))#Calculate avg package per flow
            
            total_duration = total_duration + float(row[11])					#Summation of duration per flow
            
            total_pkt_a_b = total_pkt_a_b + float(row[6])		
            total_pkt_b_a = total_pkt_b_a + float(row[8])
            
            total_bytes_a_b = total_bytes_a_b + float(row[7])		
            total_bytes_b_a = total_bytes_b_a + float(row[9])
            
            if(float(row[8])!= 0):
                total_ratio_a_b_b_a = total_ratio_a_b_b_a + (float(row[6])/float(row[8]))

            if(float(row[9])!= 0):
                total_ratio_b_a_a_b = total_ratio_b_a_a_b + (float(row[7])/float(row[9]))
            
            if(float(row[6])!= 0):
                time_floaterval_a_b = time_floaterval_a_b + (float(row[11])/float(row[6]))

            if(float(row[8])!= 0):
                time_floaterval_b_a = time_floaterval_b_a + (float(row[11])/float(row[8]))
                
            connections.add(row[0]+row[1]+row[2]+row[3])
            ips.add(row[2])

            if(float(row[11])!= 0):
                pkt_sent_per_sec =  pkt_sent_per_sec + (float(row[6])/float(row[11]))
                pkt_recv_per_sec =  pkt_recv_per_sec + (float(row[8])/float(row[11]))
                bytes_sent_per_sec =  bytes_sent_per_sec + (float(row[7])/float(row[11]))
                bytes_recv_per_sec =  bytes_recv_per_sec + (float(row[9])/float(row[11]))
               
    avg_pkt_size = avg_pkt_per_flow / count_row						#average packet size

    avg_flow_duration = total_duration / count_row						#average flow duration

    avg_pkt_a_b = total_pkt_a_b / count_row							#average no. of packets sent
    avg_pkt_b_a = total_pkt_b_a / count_row							#average no. of packets received

    avg_bytes_a_b = total_bytes_a_b / count_row						#average no. of bytes sent
    avg_bytes_b_a = total_bytes_b_a / count_row						#average no. of bytes received

    avg_ratio_a_b_b_a = total_ratio_a_b_b_a / count_row					#average ratio of incoming to outgoing
    avg_ratio_b_a_a_b = total_ratio_b_a_a_b / count_row					#average ratio of outgoing to incoming

    avg_time_floaterval_a_b =  time_floaterval_a_b /count_row
    avg_time_floaterval_b_a =  time_floaterval_b_a /count_row
   
    avg_pkt_sent_per_sec =  pkt_sent_per_sec / count_row
    avg_pkt_recv_per_sec =  pkt_recv_per_sec / count_row
    avg_bytes_sent_per_sec =  bytes_sent_per_sec / count_row
    avg_bytes_recv_per_sec =  bytes_recv_per_sec / count_row
               
    print('Average Packet size: ' + str(avg_pkt_size) + "\n")

    print('Average Flow Duration' + str(avg_flow_duration) + "\n")

    print('Average no. of packets sent' + str(avg_pkt_a_b) + "\n")
    print('Average no. of packets received' + str(avg_pkt_b_a) + "\n")

    print('Average no. of bytes sent' + str(avg_ratio_a_b_b_a) + "\n")
    print('Average no. of packets received' + str(avg_ratio_b_a_a_b) + "\n")
    
    print('Average time floaterval between packet sent' + str(avg_time_floaterval_a_b) + "\n")
    print('Average time floaterval between  packets received' + str(avg_time_floaterval_b_a) + "\n")
    print(len(connections)/len(ips))
    print('Average no. of packets sent per second' + str(avg_pkt_sent_per_sec) + "\n")
    print('Average no. of packets received per second' + str(avg_pkt_recv_per_sec) + "\n")
    print('Average bytes sent per second' + str(avg_bytes_sent_per_sec) + "\n")
    print('Average bytes received per second' + str(avg_bytes_recv_per_sec) + "\n")
    
    myFile = open('Results.csv', 'w')
    row1[1][i+1]= str(avg_pkt_size);
    row1[2][i+1]= str(avg_flow_duration);
    row1[3][i+1]= str(avg_pkt_a_b);
    row1[4][i+1]= str(avg_pkt_b_a);
    row1[5][i+1]= str(avg_bytes_a_b);
    row1[6][i+1]= str(avg_bytes_b_a);
    row1[7][i+1]= str(avg_ratio_a_b_b_a);
    row1[8][i+1]= str(avg_ratio_b_a_a_b);
    row1[9][i+1]= str(avg_time_floaterval_a_b);
    row1[10][i+1]= str(avg_time_floaterval_b_a);
    row1[11][i+1]= str(len(connections)/len(ips));
    row1[12][i+1]=str(avg_pkt_sent_per_sec);
    row1[13][i+1]=str(avg_pkt_recv_per_sec);
    row1[14][i+1]=str(avg_bytes_sent_per_sec);
    row1[15][i+1]=str(avg_bytes_recv_per_sec);

    #row1.append(['Average Packet Size',str(avg_pkt_size)])
    with myFile:
        writer = csv.writer(myFile)
        writer.writerows(row1)
    myFile.close()    
